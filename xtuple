log_format cache '***$time_local '
                     '$upstream_cache_status '
                     'Cache-Control: $upstream_http_cache_control '
                     'Expires: $upstream_http_expires '
                     '"$request" ($status) '
                     '"$http_user_agent" ';

proxy_cache_path /usr/share/nginx/cache levels=1:2 keys_zone=my-cache:8m max_size=1000m inactive=600m;
proxy_temp_path /usr/share/nginx/cache/tmp;

upstream xtuple {
        server 127.0.0.1:81;
}
upstream xtuplessl {
        server 127.0.0.1:444;
}
server {
        listen 80;
        server_name localhost; 
        access_log /var/log/nginx/localhost.access.log cache;
        error_log /var/log/nginx/localhost.error.log;
        root /usr/share/nginx/html;
        index index.html index.htm;

        location / {
                proxy_pass http://xtuple;
                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                proxy_redirect off;
                proxy_buffering off;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
}

server {
        listen 443;
        ssl on;
        ssl_certificate /etc/xtuple/lib/private/server.crt;
        ssl_certificate_key /etc/xtuple/lib/private/key.pem;
        ssl_verify_depth 3;

        server_name localhost;
        access_log /var/log/nginx/localhost.sslaccess.log cache;
        error_log /var/log/nginx/localhost.sslerror.log;
        root /usr/share/nginx/html;
        index index.html index.htm;

        ssl_protocols   SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers RC4:HIGH:!aNULL:!MD5;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        keepalive_timeout    60;

        location / {
                proxy_pass https://xtuplessl;
                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                proxy_redirect off;
                proxy_buffering on;
                proxy_buffers 8 8k;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		#turn off gzip
		proxy_set_header  Accept-Encoding  "";
                proxy_cache my-cache;
                proxy_cache_valid 200 302 60m;
                proxy_cache_valid 404 1m;
                proxy_ignore_headers "Set-Cookie";
                proxy_set_header        X-Forwarded-Proto $scheme;
                add_header      Front-End-Https   on;
                ### By default we don't want to redirect it ####
                proxy_redirect     off;
        }
}
